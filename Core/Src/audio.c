#include "audio.h"

#include "arm_math.h"
#include "arm_const_structs.h"
#include "dsp/basic_math_functions.h"

// Populated by DMA: [2 byte lo L] [2 byte hi L] [4 byte empty R channel]
volatile uint16_t rx_buffer[AUDIO_BUFFER_SIZE * 2];

// Half buffers that are copied by DMA callbacks
int32_t audio_buffer[2][AUDIO_SAMPLES_HALF];

// 0xff written by consumer
// 0 or 1 written by producer
volatile uint8_t audio_buffer_ready = 0xff;

arm_rfft_instance_q31 q31_fft;

// Temp - for debugging
volatile uint16_t half_rx_buffer[AUDIO_BUFFER_SIZE];

// Complex numbers
float fft_input[FFT_SIZE * 2];

// Magnitudes up to nyquist (half the fft size bins)
float fft_output[FFT_SIZE / 2];

float band_magnitudes[NUM_FFT_BANDS];

static const float f32_hamming_window_512[512] = {
	0.080000000f, 0.080034773f, 0.080139086f, 0.080312924f, 0.080556260f, 0.080869058f, 0.081251271f, 0.081702840f, 
	0.082223697f, 0.082813763f, 0.083472950f, 0.084201158f, 0.084998276f, 0.085864184f, 0.086798751f, 0.087801836f, 
	0.088873287f, 0.090012943f, 0.091220630f, 0.092496166f, 0.093839359f, 0.095250006f, 0.096727892f, 0.098272795f, 
	0.099884482f, 0.101562707f, 0.103307219f, 0.105117752f, 0.106994034f, 0.108935780f, 0.110942697f, 0.113014482f, 
	0.115150821f, 0.117351392f, 0.119615861f, 0.121943887f, 0.124335117f, 0.126789190f, 0.129305734f, 0.131884370f, 
	0.134524708f, 0.137226347f, 0.139988881f, 0.142811891f, 0.145694950f, 0.148637623f, 0.151639464f, 0.154700020f, 
	0.157818829f, 0.160995417f, 0.164229306f, 0.167520007f, 0.170867021f, 0.174269844f, 0.177727959f, 0.181240845f, 
	0.184807971f, 0.188428797f, 0.192102776f, 0.195829351f, 0.199607961f, 0.203438034f, 0.207318990f, 0.211250242f, 
	0.215231198f, 0.219261254f, 0.223339801f, 0.227466222f, 0.231639895f, 0.235860188f, 0.240126462f, 0.244438073f, 
	0.248794369f, 0.253194691f, 0.257638374f, 0.262124747f, 0.266653130f, 0.271222840f, 0.275833185f, 0.280483469f, 
	0.285172988f, 0.289901033f, 0.294666890f, 0.299469838f, 0.304309150f, 0.309184096f, 0.314093938f, 0.319037935f, 
	0.324015337f, 0.329025393f, 0.334067346f, 0.339140433f, 0.344243888f, 0.349376938f, 0.354538807f, 0.359728716f, 
	0.364945879f, 0.370189508f, 0.375458810f, 0.380752989f, 0.386071243f, 0.391412769f, 0.396776760f, 0.402162404f, 
	0.407568887f, 0.412995392f, 0.418441099f, 0.423905183f, 0.429386820f, 0.434885179f, 0.440399431f, 0.445928740f, 
	0.451472272f, 0.457029188f, 0.462598649f, 0.468179811f, 0.473771831f, 0.479373865f, 0.484985064f, 0.490604581f, 
	0.496231565f, 0.501865167f, 0.507504534f, 0.513148814f, 0.518797154f, 0.524448699f, 0.530102595f, 0.535757988f, 
	0.541414022f, 0.547069842f, 0.552724593f, 0.558377421f, 0.564027470f, 0.569673887f, 0.575315817f, 0.580952408f, 
	0.586582808f, 0.592206164f, 0.597821628f, 0.603428351f, 0.609025483f, 0.614612180f, 0.620187597f, 0.625750890f, 
	0.631301219f, 0.636837745f, 0.642359630f, 0.647866039f, 0.653356141f, 0.658829105f, 0.664284103f, 0.669720312f, 
	0.675136908f, 0.680533074f, 0.685907993f, 0.691260852f, 0.696590844f, 0.701897160f, 0.707179000f, 0.712435565f, 
	0.717666060f, 0.722869695f, 0.728045682f, 0.733193239f, 0.738311587f, 0.743399954f, 0.748457570f, 0.753483669f, 
	0.758477493f, 0.763438286f, 0.768365298f, 0.773257785f, 0.778115006f, 0.782936227f, 0.787720720f, 0.792467761f, 
	0.797176632f, 0.801846621f, 0.806477023f, 0.811067137f, 0.815616270f, 0.820123733f, 0.824588846f, 0.829010932f, 
	0.833389324f, 0.837723359f, 0.842012383f, 0.846255746f, 0.850452808f, 0.854602934f, 0.858705496f, 0.862759874f, 
	0.866765455f, 0.870721634f, 0.874627812f, 0.878483399f, 0.882287812f, 0.886040476f, 0.889740823f, 0.893388294f, 
	0.896982338f, 0.900522411f, 0.904007978f, 0.907438512f, 0.910813494f, 0.914132414f, 0.917394770f, 0.920600070f, 
	0.923747828f, 0.926837568f, 0.929868825f, 0.932841138f, 0.935754059f, 0.938607147f, 0.941399972f, 0.944132110f, 
	0.946803149f, 0.949412685f, 0.951960324f, 0.954445679f, 0.956868376f, 0.959228049f, 0.961524340f, 0.963756902f, 
	0.965925398f, 0.968029499f, 0.970068889f, 0.972043258f, 0.973952308f, 0.975795750f, 0.977573306f, 0.979284707f, 
	0.980929694f, 0.982508019f, 0.984019442f, 0.985463736f, 0.986840682f, 0.988150071f, 0.989391707f, 0.990565400f, 
	0.991670974f, 0.992708262f, 0.993677107f, 0.994577361f, 0.995408890f, 0.996171567f, 0.996865277f, 0.997489916f, 
	0.998045388f, 0.998531610f, 0.998948509f, 0.999296021f, 0.999574093f, 0.999782684f, 0.999921762f, 0.999991307f, 
	0.999991307f, 0.999921762f, 0.999782684f, 0.999574093f, 0.999296021f, 0.998948509f, 0.998531610f, 0.998045388f, 
	0.997489916f, 0.996865277f, 0.996171567f, 0.995408890f, 0.994577361f, 0.993677107f, 0.992708262f, 0.991670974f, 
	0.990565400f, 0.989391707f, 0.988150071f, 0.986840682f, 0.985463736f, 0.984019442f, 0.982508019f, 0.980929694f, 
	0.979284707f, 0.977573306f, 0.975795750f, 0.973952308f, 0.972043258f, 0.970068889f, 0.968029499f, 0.965925398f, 
	0.963756902f, 0.961524340f, 0.959228049f, 0.956868376f, 0.954445679f, 0.951960324f, 0.949412685f, 0.946803149f, 
	0.944132110f, 0.941399972f, 0.938607147f, 0.935754059f, 0.932841138f, 0.929868825f, 0.926837568f, 0.923747828f, 
	0.920600070f, 0.917394770f, 0.914132414f, 0.910813494f, 0.907438512f, 0.904007978f, 0.900522411f, 0.896982338f, 
	0.893388294f, 0.889740823f, 0.886040476f, 0.882287812f, 0.878483399f, 0.874627812f, 0.870721634f, 0.866765455f, 
	0.862759874f, 0.858705496f, 0.854602934f, 0.850452808f, 0.846255746f, 0.842012383f, 0.837723359f, 0.833389324f, 
	0.829010932f, 0.824588846f, 0.820123733f, 0.815616270f, 0.811067137f, 0.806477023f, 0.801846621f, 0.797176632f, 
	0.792467761f, 0.787720720f, 0.782936227f, 0.778115006f, 0.773257785f, 0.768365298f, 0.763438286f, 0.758477493f, 
	0.753483669f, 0.748457570f, 0.743399954f, 0.738311587f, 0.733193239f, 0.728045682f, 0.722869695f, 0.717666060f, 
	0.712435565f, 0.707179000f, 0.701897160f, 0.696590844f, 0.691260852f, 0.685907993f, 0.680533074f, 0.675136908f, 
	0.669720312f, 0.664284103f, 0.658829105f, 0.653356141f, 0.647866039f, 0.642359630f, 0.636837745f, 0.631301219f, 
	0.625750890f, 0.620187597f, 0.614612180f, 0.609025483f, 0.603428351f, 0.597821628f, 0.592206164f, 0.586582808f, 
	0.580952408f, 0.575315817f, 0.569673887f, 0.564027470f, 0.558377421f, 0.552724593f, 0.547069842f, 0.541414022f, 
	0.535757988f, 0.530102595f, 0.524448699f, 0.518797154f, 0.513148814f, 0.507504534f, 0.501865167f, 0.496231565f, 
	0.490604581f, 0.484985064f, 0.479373865f, 0.473771831f, 0.468179811f, 0.462598649f, 0.457029188f, 0.451472272f, 
	0.445928740f, 0.440399431f, 0.434885179f, 0.429386820f, 0.423905183f, 0.418441099f, 0.412995392f, 0.407568887f, 
	0.402162404f, 0.396776760f, 0.391412769f, 0.386071243f, 0.380752989f, 0.375458810f, 0.370189508f, 0.364945879f, 
	0.359728716f, 0.354538807f, 0.349376938f, 0.344243888f, 0.339140433f, 0.334067346f, 0.329025393f, 0.324015337f, 
	0.319037935f, 0.314093938f, 0.309184096f, 0.304309150f, 0.299469838f, 0.294666890f, 0.289901033f, 0.285172988f, 
	0.280483469f, 0.275833185f, 0.271222840f, 0.266653130f, 0.262124747f, 0.257638374f, 0.253194691f, 0.248794369f, 
	0.244438073f, 0.240126462f, 0.235860188f, 0.231639895f, 0.227466222f, 0.223339801f, 0.219261254f, 0.215231198f, 
	0.211250242f, 0.207318990f, 0.203438034f, 0.199607961f, 0.195829351f, 0.192102776f, 0.188428797f, 0.184807971f, 
	0.181240845f, 0.177727959f, 0.174269844f, 0.170867021f, 0.167520007f, 0.164229306f, 0.160995417f, 0.157818829f, 
	0.154700020f, 0.151639464f, 0.148637623f, 0.145694950f, 0.142811891f, 0.139988881f, 0.137226347f, 0.134524708f, 
	0.131884370f, 0.129305734f, 0.126789190f, 0.124335117f, 0.121943887f, 0.119615861f, 0.117351392f, 0.115150821f, 
	0.113014482f, 0.110942697f, 0.108935780f, 0.106994034f, 0.105117752f, 0.103307219f, 0.101562707f, 0.099884482f, 
	0.098272795f, 0.096727892f, 0.095250006f, 0.093839359f, 0.092496166f, 0.091220630f, 0.090012943f, 0.088873287f, 
	0.087801836f, 0.086798751f, 0.085864184f, 0.084998276f, 0.084201158f, 0.083472950f, 0.082813763f, 0.082223697f, 
	0.081702840f, 0.081251271f, 0.080869058f, 0.080556260f, 0.080312924f, 0.080139086f, 0.080034773f, 0.080000000f
};

const uint16_t band_edges[NUM_FFT_BANDS + 1] = {
	1,   // Start at bin 1 (skip DC)
	2,   // 125 Hz
	4,   // 250 Hz  
	8,   // 500 Hz
	16,  // 1 kHz
	32,  // 2 kHz
	64,  // 4 kHz
	128, // 8 kHz
	255  // 16 kHz (Nyquist)
};

void write_half_audio_buffer(volatile uint16_t *rx_buffer_start, int buffer_idx) {
	for (int i = 0; i < AUDIO_BUFFER_SIZE; i++) {
		half_rx_buffer[i] = rx_buffer_start[i];
	}
	for (int i = 0; i < AUDIO_SAMPLES_HALF; i++) {
		// Index for left channel: skip right channel (4 halfwords per stereo frame)
		uint16_t hi = rx_buffer_start[4 * i];      // High 16 bits of 24-bit sample (0xFFFC)
		uint16_t lo = rx_buffer_start[4 * i + 1];  // Low 16 bits of 24-bit sample (0x4400)
		// Combine: frame = [hi 16 bits][lo 16 bits] = 0xFFFC4400
		// The 24-bit sample is left-justified in bits 31-8, so the actual sample is in hi:lo
		int32_t frame = (int32_t)((uint32_t)hi << 16) | lo;
		// Extract signed 24-bit sample: shift right by 8 to get bits 31-8
		// This gives us the 24-bit sample value (0x00FFFC44 after shift)
		int32_t sample_24bit = frame >> 8;  // Sign-extends correctly for negative values
		audio_buffer[buffer_idx][i] = sample_24bit;
	}
	audio_buffer_ready = buffer_idx;
}

void init_audio() {

}

void process_audio() {
	if (audio_buffer_ready == 0xff) {
		return;
	}

	uint8_t buffer_idx = audio_buffer_ready;
	audio_buffer_ready = 0xff;

	for (int i = 0; i < FFT_SIZE; i++) {
		// Convert 24-bit signed sample to float
		int32_t sample_24bit = audio_buffer[buffer_idx][i];
		float sample = (float)sample_24bit / 8388608.0f;

		fft_input[i * 2] = sample * f32_hamming_window_512[i];
		
		// Apply window and store as complex (real, imaginary)
		// arm_mult_q31(&sample_q31, &hamming_window[i], &fft_input[i * 2], 1);

		fft_input[i * 2 + 1] = 0; // Zero imaginary part
	}

	// In place FFT
	// arm_cfft_q31(&arm_cfft_sR_q31_len512, fft_input, 0, 1);

	arm_cfft_f32(&arm_cfft_sR_f32_len512, fft_input, 0, 1);

	// FFT conjugate symmetry, we only need to get magnitude of first half
	// arm_cmplx_mag_q31(fft_input, fft_output, FFT_SIZE / 2);

	arm_cmplx_mag_f32(fft_input, fft_output, FFT_SIZE / 2);

	// Avg linear bins into logarithmic bands
	for (int band = 0; band < NUM_FFT_BANDS; band++) {
		float sum = 0;
		uint16_t count = band_edges[band + 1] - band_edges[band];

		for (int bin = band_edges[band]; bin < band_edges[band+1]; bin++) {
			sum += fft_output[bin];
		}

		float avg = sum / count;
		band_magnitudes[band] = (avg > 1.f) ? 1.f : avg;
	}
}
